<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>USS Pro</title>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#121212',
                        surface: '#1e1e1e',
                        'surface-hover': '#2d2d2d',
                        primary: '#bb86fc',
                        'primary-dark': '#a370f7',
                        secondary: '#03dac6',
                        error: '#cf6679',
                        success: '#4caf50',
                        text: '#ffffff',
                        'text-sec': '#b0b0b0',
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .btn {
                @apply px-5 py-2.5 rounded text-sm font-medium uppercase tracking-wide transition-all duration-200 ease-out focus:outline-none focus:ring-0 active:scale-95;
            }
            .btn-primary {
                @apply bg-primary text-black shadow-md hover:bg-primary-dark hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none;
            }
            .btn-outline {
                @apply border border-gray-600 text-text hover:bg-white/10;
            }
            
            /* Custom Scrollbar */
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #121212; 
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #444; 
                border-radius: 4px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #555; 
            }
        }

        /* Logic to prevent sticky hover on touch devices */
        @media (hover: hover) {
            .option-btn:hover {
                background-color: rgba(255,255,255,0.08);
                border-color: #bb86fc;
                color: #ffffff;
                transform: translateY(-1px);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            }
        }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #bb86fc;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #bb86fc;
        }

        /* --- ANIMATIONS --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-4px); }
            40%, 80% { transform: translateX(4px); }
        }
        @keyframes success-pop {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        .animate-success {
            animation: success-pop 0.4s ease-out forwards;
        }
        .animate-fade-in {
            animation: fade-in-up 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-bg text-text font-sans min-h-screen flex flex-col custom-scrollbar">

<div id="main-container" class="container mx-auto px-4 py-4 flex flex-col flex-grow">
    <!-- Header -->
    <header id="main-header" class="flex justify-between items-center mb-8">
        <h4 class="text-xl font-light">
            <i class="fas fa-graduation-cap text-primary mr-2"></i>
            USS <span class="font-bold">Pro</span>
        </h4>
        <button class="btn btn-outline text-xs py-1.5 px-3" onclick="app.showSection('home')">
            <i class="fas fa-home"></i>
        </button>
    </header>

    <div id="app-sections" class="flex-grow flex flex-col">
        
        <!-- SECTION: HOME -->
        <div id="home-section" class="section-content flex-grow animate-fade-in">
            
            <!-- Compact Stats -->
            <div class="bg-surface rounded-xl border border-gray-700 p-4 mb-6 shadow-lg">
                <div class="grid grid-cols-3 divide-x divide-gray-700">
                    <div class="flex flex-col items-center justify-center px-2">
                        <div class="text-2xl md:text-4xl font-bold text-white mb-1" id="stat-total">0</div>
                        <div class="text-[10px] md:text-xs text-text-sec uppercase tracking-wider">Total</div>
                    </div>
                    <div class="flex flex-col items-center justify-center px-2">
                        <div class="text-2xl md:text-4xl font-bold text-success mb-1" id="stat-wins">0</div>
                        <div class="text-[10px] md:text-xs text-text-sec uppercase tracking-wider">Passed</div>
                    </div>
                    <div class="flex flex-col items-center justify-center px-2">
                        <div class="text-2xl md:text-4xl font-bold text-secondary mb-1" id="stat-rate">0%</div>
                        <div class="text-[10px] md:text-xs text-text-sec uppercase tracking-wider">Win Rate</div>
                    </div>
                </div>
            </div>

            <div class="bg-surface rounded-xl shadow-lg p-8 text-center flex flex-col justify-center flex-grow max-w-2xl mx-auto w-full">
                <h2 class="text-3xl font-light mb-4">Welcome Back</h2>
                <p class="text-text-sec mb-8 max-w-md mx-auto">
                    Prepare for your scholarship exam with our adaptive mock tests. Track your progress across all subjects.
                </p>
                
                <div class="grid gap-4 w-full max-w-md mx-auto">
                    <button class="btn btn-primary text-lg py-3" onclick="app.startFullQuiz()">
                        <i class="fas fa-play mr-2"></i> Start Full Mock Exam
                    </button>
                    <button class="btn btn-outline py-3" onclick="app.showSubjectModal()">
                        <i class="fas fa-layer-group mr-2"></i> Practice by Subject
                    </button>
                    <button class="btn btn-outline border-dashed opacity-70 hover:opacity-100 py-3" onclick="app.showHistory()">
                        <i class="fas fa-history mr-2"></i> View History
                    </button>
                </div>
                <div id="loading-indicator" class="mt-6 text-text-sec text-sm hidden">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Loading questions database...
                </div>
            </div>
        </div>

        <!-- SECTION: QUIZ -->
        <div id="quiz-section" class="hidden flex-col h-full animate-fade-in">
            <!-- Quiz Header -->
            <div class="bg-surface rounded-xl p-4 mb-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-md border border-gray-800">
                <div class="flex items-center w-full justify-between md:justify-start">
                    <span class="bg-gray-800 border border-gray-700 text-text-sec px-3 py-1 rounded-full text-sm" id="subject-indicator">Subject</span>
                    <div class="md:ml-4 flex items-center">
                         <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-green-900/30 text-success border border-success text-sm font-medium" id="score-counter">
                             <i class="fas fa-star"></i> 0
                         </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 w-full justify-end">
                    <!-- Custom Toggle -->
                    <div class="flex items-center">
                        <label for="langToggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="langToggle" class="sr-only" onchange="app.toggleLanguage()">
                                <div class="w-10 h-4 bg-gray-700 rounded-full shadow-inner"></div>
                                <div class="dot absolute w-6 h-6 bg-white rounded-full shadow -left-1 -top-1 transition text-primary flex items-center justify-center text-xs">
                                    <i class="fas fa-language"></i>
                                </div>
                            </div>
                            <div class="ml-3 text-text-sec text-xs font-medium">MAL / ENG</div>
                        </label>
                    </div>

                    <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-900/20 text-error border border-error text-sm font-mono w-24 justify-center" id="timer">
                        <i class="far fa-clock"></i> 00:00
                    </div>
                </div>
            </div>
            
            <!-- Quiz Card -->
            <div class="bg-surface rounded-xl shadow-lg p-4 md:p-6 flex-grow flex flex-col border border-gray-800">
                <!-- Progress Bar -->
                <div class="w-full bg-gray-700 rounded-full h-1.5 mb-2">
                    <div class="bg-secondary h-1.5 rounded-full transition-all duration-300" id="quiz-progress" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mb-4">
                     <small class="text-text-sec text-xs uppercase tracking-wide" id="question-counter">Question 1 of 45</small>
                </div>

                <!-- Scrollable Content Area -->
                <div id="question-container" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                    <!-- Question Image -->
                    <div id="q-image-container" class="text-center hidden mb-4 animate-fade-in">
                        <img id="q-image" src="" class="max-w-full h-48 object-contain mx-auto rounded border border-gray-700" alt="Question Diagram">
                    </div>
                    
                    <!-- Question Text -->
                    <h5 class="font-normal leading-relaxed text-gray-100 mb-6 animate-fade-in" id="q-text" style="font-size: clamp(1.1rem, 3.5vh, 1.6rem);">
                        Loading question...
                    </h5>
                    
                    <!-- Options -->
                    <div class="flex flex-col gap-3" id="options-container">
                        <!-- Options generated by JS -->
                    </div>
                </div>
                
                <div class="mt-4 pt-2 border-t border-gray-800 flex justify-end" id="next-btn-container">
                    <button class="btn btn-primary px-8" id="next-btn" onclick="app.nextQuestion()" disabled>
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- SECTION: RESULT -->
        <div id="result-section" class="hidden animate-fade-in">
            <div class="bg-surface rounded-xl shadow-lg p-8 text-center max-w-3xl mx-auto border border-gray-800">
                <h3 class="text-2xl font-light mb-8">Performance Report</h3>
                
                <div id="score-circle" class="w-40 h-40 rounded-full border-4 border-gray-700 flex items-center justify-center mx-auto mb-6 relative">
                    <span class="text-5xl font-light">0%</span>
                    <span class="absolute bottom-8 text-[10px] text-text-sec tracking-[0.2em] uppercase">Score</span>
                </div>
                
                <h4 id="result-message" class="text-xl font-bold mb-2"></h4>
                <p class="text-text-sec mb-8" id="result-time">Time Taken: 00:00</p>
                
                <!-- Average Time Insight -->
                <div class="inline-flex items-center bg-gray-800/50 border border-gray-700 rounded-lg p-4 mb-8 text-left max-w-sm w-full">
                    <div class="bg-surface p-3 rounded-full mr-4 text-text-sec">
                        <i class="fas fa-stopwatch fa-xl"></i>
                    </div>
                    <div>
                        <div class="text-xs text-text-sec uppercase tracking-wider mb-1">Avg. Time / Question</div>
                        <div class="font-bold text-xl" id="result-avg-time">-- s</div>
                        <small id="avg-time-feedback" class="text-xs"></small>
                    </div>
                </div>

                <h6 class="text-left text-text-sec text-xs uppercase tracking-widest mb-4 border-b border-gray-800 pb-2">Subject Breakdown</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left mb-8" id="subject-performance">
                    <!-- Subject breakdown injected here -->
                </div>

                <div class="bg-black/20 rounded-lg border border-gray-700 p-4 text-left">
                    <div class="grid grid-cols-2 gap-4 divide-x divide-gray-700">
                        <div class="pl-2">
                            <small class="text-text-sec text-[10px] uppercase tracking-wider">Strongest Subject</small>
                            <div id="strong-subject" class="font-bold text-success mt-1 text-lg">-</div>
                        </div>
                        <div class="pl-6">
                            <small class="text-text-sec text-[10px] uppercase tracking-wider">Needs Improvement</small>
                            <div id="weak-subject" class="font-bold text-error mt-1 text-lg">-</div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center gap-4 mt-8">
                    <button class="btn btn-outline px-6" onclick="app.showSection('home')">Home</button>
                    <button class="btn btn-primary px-6" onclick="app.startFullQuiz()">Try Again</button>
                </div>
            </div>
        </div>

        <!-- SECTION: HISTORY -->
        <div id="history-section" class="hidden animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-xl font-light">Exam History</h4>
                <button class="btn border border-error text-error hover:bg-error/10 text-xs py-1 px-3" onclick="app.clearHistory()">
                    <i class="fas fa-trash-alt mr-2"></i> Clear Data
                </button>
            </div>
            <div id="history-list" class="space-y-3">
                <!-- History items -->
            </div>
        </div>

    </div>
</div>

<!-- MODAL: Subject Selection -->
<div id="subjectModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden" aria-hidden="true">
    <div class="bg-surface w-full max-w-lg rounded-xl shadow-2xl border border-gray-700 overflow-hidden m-4 flex flex-col max-h-[80vh] animate-fade-in">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-surface-hover">
            <h5 class="text-lg font-light" id="modal-title">Select Subject</h5>
            <button class="text-gray-400 hover:text-white transition-colors" onclick="app.closeModal('subjectModal')">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-0 overflow-y-auto custom-scrollbar" id="modal-body">
            <div class="divide-y divide-gray-700" id="subject-list">
                <!-- Subjects generated here -->
            </div>
        </div>
    </div>
</div>

<!-- MODAL: History Details -->
<div id="historyDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden" aria-hidden="true">
    <div class="bg-surface w-full max-w-2xl rounded-xl shadow-2xl border border-gray-700 overflow-hidden m-4 flex flex-col max-h-[85vh] animate-fade-in">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-surface-hover">
            <h5 class="text-lg font-light">Exam Details</h5>
            <button class="text-gray-400 hover:text-white transition-colors" onclick="app.closeModal('historyDetailsModal')">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar" id="history-modal-body">
            <!-- Content Injected via JS -->
        </div>
    </div>
</div>

<style>
    /* Styling for the custom toggle switch dot */
    input:checked ~ .dot {
        transform: translateX(100%);
    }
    
    /* Option Button Base Styles (Tailwind abstraction) */
    .option-btn {
        @apply w-full text-left p-4 rounded-lg border-2 border-gray-700 text-gray-200 bg-surface-hover/30 transition-all duration-200 text-base relative disabled:opacity-100 mb-3;
    }
    
    .option-btn.correct {
        @apply bg-green-900/30 border-green-500 text-green-400 animate-success !important;
    }
    
    .option-btn.wrong {
        @apply bg-red-900/30 border-red-500 text-red-400 animate-shake !important;
    }

    /* Score Circle states */
    #score-circle.pass {
        @apply border-success text-success shadow-[0_0_30px_rgba(76,175,80,0.2)];
    }
    #score-circle.fail {
        @apply border-error text-error shadow-[0_0_30px_rgba(207,102,121,0.2)];
    }
</style>

<script>
/* === COPY TO script.js === */

let QUESTIONS_DB = [];

/**
 * APP DATA & CONFIGURATION
 */
const CONFIG = {
    passMark: 70, 
    avgTimeTarget: 120, 
    examStructure: [
        { subject: "Part I Malayalam", count: 5 },
        { subject: "Part II Malayalam", count: 5 },
        { subject: "Maths", count: 10 },
        { subject: "English", count: 5 },
        { subject: "Basic Science", count: 10 },
        { subject: "Social Science", count: 10 }
    ]
};

// Fallback data
const FALLBACK_DATA = [
    { "question": "The length and width of a rectangular park are 9/4 metre and 8/3 metre respectively. Find the area of the park", "malayalam_question": "ദീർഘചതുരാകൃതിയിലുള്ള പാർക്കിൻ്റെ നീളവും വീതിയും യഥാക്രമം 9/4 മീറ്ററും 8/3 മീറ്ററുമാണ്. പാർക്കിൻ്റെ പ്രദേശം കണ്ടെത്തുക", "option1": "6 square metre", "malayalam_option1": "6 ചതുരശ്ര മീറ്റർ", "option2": "4 square metre", "malayalam_option2": "4 ചതുരശ്ര മീറ്റർ", "option3": "9/2 square metre", "malayalam_option3": "9/2 ചതുരശ്ര മീറ്റർ", "option4": "10 square metre", "malayalam_option4": "10 ചതുരശ്ര മീറ്റർ", "answer": "6 square metre", "malayalam_answer": "6 ചതുരശ്ര മീറ്റർ", "subject": "Maths", "chapter": 2, "image": "null" },
    { "question": "Who wrote the poem 'Veena Poovu'?", "malayalam_question": "'വീണപൂവ്' എന്ന കവിത ആരാണ് രചിച്ചത്?", "option1": "Kumaran Asan", "malayalam_option1": "കുമാരനാശാൻ", "option2": "Vallathol", "malayalam_option2": "വള്ളത്തോൾ", "option3": "Ulloor", "malayalam_option3": "ഉള്ളൂർ", "option4": "Changampuzha", "malayalam_option4": "ചങ്ങമ്പുഴ", "answer": "Kumaran Asan", "malayalam_answer": "കുമാരനാശാൻ", "subject": "Part I Malayalam", "chapter": 1, "image": "null" }
];

const utils = {
    shuffle: (array) => {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    },
    formatTime: (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
};

const app = {
    state: {
        currentQuestions: [],
        currentQuestionIndex: 0,
        score: 0,
        answers: [], 
        timer: 0,
        timerInterval: null,
        language: 'en',
        isQuizActive: false,
        startTime: 0,
        tempSubjectStats: null
    },

    init: async () => {
        app.loadStats();
        app.renderHistory();
        await app.fetchQuestions();
    },

    fetchQuestions: async () => {
        const loading = document.getElementById('loading-indicator');
        if(loading) loading.classList.remove('hidden');
        try {
            const response = await fetch('questions.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            QUESTIONS_DB = await response.json();
        } catch (error) {
            console.warn("Using fallback data.", error);
            QUESTIONS_DB = FALLBACK_DATA; 
        } finally {
            if(loading) loading.classList.add('hidden');
        }
    },

    loadStats: () => {
        const stats = JSON.parse(localStorage.getItem('quizStats')) || { total: 0, wins: 0 };
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-wins').textContent = stats.wins;
        const rate = stats.total > 0 ? Math.round((stats.wins / stats.total) * 100) : 0;
        document.getElementById('stat-rate').textContent = `${rate}%`;
    },

    saveStats: (isWin, totalTimeStr, avgTimeSec) => {
        const stats = JSON.parse(localStorage.getItem('quizStats')) || { total: 0, wins: 0 };
        stats.total++;
        if (isWin) stats.wins++;
        localStorage.setItem('quizStats', JSON.stringify(stats));
        
        const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
        const entry = {
            date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            score: app.state.score,
            total: app.state.currentQuestions.length,
            percentage: Math.round((app.state.score / app.state.currentQuestions.length) * 100),
            timeTaken: totalTimeStr,
            avgTime: avgTimeSec,
            subjectDetails: app.state.tempSubjectStats
        };
        history.unshift(entry);
        if(history.length > 20) history.pop();
        localStorage.setItem('quizHistory', JSON.stringify(history));
    },

    showSection: (sectionId) => {
        // Hide all
        document.getElementById('home-section').classList.add('hidden');
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('result-section').classList.add('hidden');
        document.getElementById('history-section').classList.add('hidden');
        
        // Show Target
        const target = document.getElementById(`${sectionId}-section`);
        target.classList.remove('hidden');
        
        const mainHeader = document.getElementById('main-header');
        if (sectionId === 'quiz') {
            document.body.classList.add('quiz-mode');
            mainHeader.classList.add('hidden'); 
            target.classList.add('flex'); // Quiz needs flex
        } else {
            document.body.classList.remove('quiz-mode');
            mainHeader.classList.remove('hidden'); 
            target.classList.remove('flex'); // Others are block
            if (sectionId === 'home') app.loadStats();
        }
    },

    toggleLanguage: () => {
        const toggle = document.getElementById('langToggle');
        app.state.language = toggle.checked ? 'mal' : 'en';
        if (app.state.isQuizActive) {
            app.renderCurrentQuestion(false); 
        }
    },

    // --- Modal Logic (Tailwind) ---
    openModal: (modalId) => {
        const modal = document.getElementById(modalId);
        if(modal) modal.classList.remove('hidden');
    },

    closeModal: (modalId) => {
        const modal = document.getElementById(modalId);
        if(modal) modal.classList.add('hidden');
    },

    startFullQuiz: () => {
        if (!QUESTIONS_DB || QUESTIONS_DB.length === 0) {
            alert("Questions data not loaded. Please check questions.json.");
            return;
        }
        let finalQuestions = [];
        CONFIG.examStructure.forEach(req => {
            let subjectQs = QUESTIONS_DB.filter(q => q.subject === req.subject);
            subjectQs = utils.shuffle(subjectQs);
            while(subjectQs.length > 0 && subjectQs.length < req.count) {
                subjectQs = subjectQs.concat(subjectQs);
            }
            finalQuestions = finalQuestions.concat(subjectQs.slice(0, req.count));
        });
        if (finalQuestions.length === 0) {
            alert("No questions found matching the exam criteria.");
            return;
        }
        app.startQuizExecution(finalQuestions);
    },

    startSubjectFlow: (subjectName) => {
        const qs = QUESTIONS_DB.filter(q => q.subject === subjectName);
        if(qs.length === 0) {
            alert("No questions available for this subject.");
            return;
        }
        const chapters = [...new Set(qs.map(q => q.chapter))].filter(c => c != null).sort();
        if (chapters.length === 0) {
            app.closeModal('subjectModal');
            app.startQuizExecution(utils.shuffle(qs).slice(0, 20));
            return;
        }
        
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        modalTitle.textContent = `Select Chapters: ${subjectName}`;
        
        let html = `
            <div class="p-6">
                <div class="flex items-center mb-4 pb-4 border-b border-gray-700">
                    <input type="checkbox" id="selectAllChapters" class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-secondary focus:ring-secondary" checked onchange="app.toggleAllChapters(this)">
                    <label for="selectAllChapters" class="ml-3 text-sm font-medium text-white">Select All Chapters</label>
                </div>
                <div id="chapter-checkboxes" class="space-y-3 mb-6 max-h-60 overflow-y-auto custom-scrollbar pr-2">
        `;
        chapters.forEach(chap => {
            html += `
                <div class="flex items-center">
                    <input type="checkbox" value="${chap}" id="chap_${chap}" class="chapter-chk w-4 h-4 rounded border-gray-600 bg-gray-700 text-secondary focus:ring-offset-0 focus:ring-secondary" checked>
                    <label for="chap_${chap}" class="ml-3 text-sm text-gray-300">Chapter ${chap}</label>
                </div>
            `;
        });
        html += `
                </div>
                <div class="flex justify-between pt-2">
                    <button class="text-sm text-gray-400 hover:text-white underline" onclick="app.populateSubjectModal()">Back to Subjects</button>
                    <button class="btn btn-primary px-6" onclick="app.confirmChapterSelection('${subjectName}')">Start Practice</button>
                </div>
            </div>
        `;
        modalBody.innerHTML = html;
    },

    toggleAllChapters: (source) => {
        const checkboxes = document.querySelectorAll('.chapter-chk');
        checkboxes.forEach(chk => chk.checked = source.checked);
    },

    confirmChapterSelection: (subjectName) => {
        const checkboxes = document.querySelectorAll('.chapter-chk:checked');
        const selectedChapters = Array.from(checkboxes).map(cb => cb.value); 
        if (selectedChapters.length === 0) { alert("Please select at least one chapter."); return; }
        let qs = QUESTIONS_DB.filter(q => q.subject === subjectName && selectedChapters.includes(String(q.chapter)));
        if (qs.length === 0) { alert("No questions match the selected criteria."); return; }
        app.closeModal('subjectModal');
        app.startQuizExecution(utils.shuffle(qs).slice(0, 25));
    },

    startQuizExecution: (questions) => {
        app.state.currentQuestions = questions;
        app.state.currentQuestionIndex = 0;
        app.state.score = 0;
        app.state.answers = [];
        app.state.timer = 0;
        app.state.isQuizActive = true;
        
        document.getElementById('next-btn').disabled = true;
        document.getElementById('options-container').innerHTML = '';
        document.getElementById('score-counter').innerHTML = '<i class="fas fa-star"></i> 0';
        
        app.showSection('quiz');
        app.startTimer();
        app.renderCurrentQuestion(true);
    },

    startTimer: () => {
        if (app.state.timerInterval) clearInterval(app.state.timerInterval);
        app.state.timerInterval = setInterval(() => {
            app.state.timer++;
            document.getElementById('timer').innerHTML = `<i class="far fa-clock"></i> ${utils.formatTime(app.state.timer)}`;
        }, 1000);
    },

    renderCurrentQuestion: (isNewQuestion = false) => {
        const q = app.state.currentQuestions[app.state.currentQuestionIndex];
        const isMal = app.state.language === 'mal';
        
        if (document.activeElement instanceof HTMLElement) document.activeElement.blur();

        document.getElementById('subject-indicator').textContent = q.subject;
        document.getElementById('question-counter').textContent = `Question ${app.state.currentQuestionIndex + 1} of ${app.state.currentQuestions.length}`;
        document.getElementById('quiz-progress').style.width = `${((app.state.currentQuestionIndex) / app.state.currentQuestions.length) * 100}%`;
        document.getElementById('q-text').textContent = isMal ? q.malayalam_question : q.question;

        const imgContainer = document.getElementById('q-image-container');
        const img = document.getElementById('q-image');
        if (q.image && q.image !== "null" && q.image !== null) {
            img.src = q.image; imgContainer.classList.remove('hidden'); img.onerror = function() { imgContainer.classList.add('hidden'); };
        } else { imgContainer.classList.add('hidden'); }

        const container = document.getElementById('options-container');
        const scrollContainer = document.getElementById('question-container');
        
        if (isNewQuestion) {
            if(scrollContainer) scrollContainer.scrollTop = 0;
            
            container.innerHTML = '';
            const options = [
                { id: 1, text: q.option1, mal: q.malayalam_option1 },
                { id: 2, text: q.option2, mal: q.malayalam_option2 },
                { id: 3, text: q.option3, mal: q.malayalam_option3 },
                { id: 4, text: q.option4, mal: q.malayalam_option4 }
            ];
            utils.shuffle(options).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn animate-fade-in'; 
                btn.dataset.optId = opt.id;
                btn.textContent = isMal ? opt.mal : opt.text;
                btn.onclick = () => app.handleAnswer(btn, opt, q);
                container.appendChild(btn);
            });
            document.getElementById('next-btn').disabled = true;
        } else {
            const buttons = container.querySelectorAll('button');
            buttons.forEach((btn) => {
                const qKey = `option${btn.dataset.optId}`;
                const malKey = `malayalam_option${btn.dataset.optId}`;
                btn.textContent = isMal ? q[malKey] : q[qKey];
            });
        }
    },

    handleAnswer: (btn, optionObj, questionObj) => {
        const container = document.getElementById('options-container');
        const buttons = container.querySelectorAll('button');
        buttons.forEach(b => b.disabled = true);
        btn.blur();

        const correctAnswerText = String(questionObj.answer).trim();
        const selectedText = String(questionObj[`option${optionObj.id}`]).trim();
        const isCorrect = selectedText === correctAnswerText;
        
        if (isCorrect) {
            btn.classList.add('correct');
            btn.innerHTML += ' <i class="fas fa-check float-right mt-1"></i>';
            app.state.score++;
            document.getElementById('score-counter').innerHTML = `<i class="fas fa-star"></i> ${app.state.score}`;
        } else {
            btn.classList.add('wrong');
            btn.innerHTML += ' <i class="fas fa-times float-right mt-1"></i>';
            buttons.forEach(b => {
                const optText = String(questionObj[`option${b.dataset.optId}`]).trim();
                if (optText === correctAnswerText) {
                    b.classList.add('correct');
                    b.innerHTML += ' <i class="fas fa-check float-right mt-1"></i>';
                }
            });
        }

        app.state.answers.push({ subject: questionObj.subject, isCorrect: isCorrect, time: Date.now() });
        setTimeout(() => { app.nextQuestion(); }, 1500); 
    },

    nextQuestion: () => {
        app.state.currentQuestionIndex++;
        if (app.state.currentQuestionIndex < app.state.currentQuestions.length) {
            app.renderCurrentQuestion(true);
        } else {
            app.finishQuiz();
        }
    },

    finishQuiz: () => {
        clearInterval(app.state.timerInterval);
        app.state.isQuizActive = false;

        const totalQs = app.state.currentQuestions.length;
        const percentage = Math.round((app.state.score / totalQs) * 100);
        const passed = percentage >= CONFIG.passMark;
        const timeTaken = document.getElementById('timer').textContent;
        const totalSeconds = app.state.timer;
        const avgSeconds = Math.round(totalSeconds / totalQs);

        // Render Result Page
        const circle = document.getElementById('score-circle');
        circle.className = `w-40 h-40 rounded-full border-4 flex items-center justify-center mx-auto mb-6 relative ${passed ? 'pass' : 'fail'}`;
        circle.querySelector('span:first-child').textContent = `${percentage}%`;

        const msgEl = document.getElementById('result-message');
        msgEl.textContent = passed ? "Excellent Work!" : "Don't Give Up!";
        msgEl.className = `text-2xl font-bold mb-2 ${passed ? "text-success" : "text-error"}`;

        document.getElementById('result-time').textContent = `Total Time: ${timeTaken.trim()}`;

        // Avg Time Logic
        document.getElementById('result-avg-time').textContent = `${avgSeconds} seconds`;
        const avgFeedback = document.getElementById('avg-time-feedback');
        if (avgSeconds <= CONFIG.avgTimeTarget) {
            avgFeedback.textContent = "Great! You are within the time limit.";
            avgFeedback.className = "text-success font-medium";
        } else {
            avgFeedback.textContent = "Try to answer faster (Target: 120s)";
            avgFeedback.className = "text-yellow-500 font-medium";
        }

        // Stats
        const subjectStats = {};
        app.state.answers.forEach(ans => {
            if (!subjectStats[ans.subject]) subjectStats[ans.subject] = { correct: 0, total: 0 };
            subjectStats[ans.subject].total++;
            if (ans.isCorrect) subjectStats[ans.subject].correct++;
        });
        
        app.state.tempSubjectStats = subjectStats;
        app.renderSubjectPerformance(subjectStats, 'subject-performance');

        // Strong/Weak
        let bestSub = { name: '-', val: -1 };
        let worstSub = { name: '-', val: 101 };
        Object.keys(subjectStats).forEach(sub => {
            const data = subjectStats[sub];
            const perc = Math.round((data.correct / data.total) * 100);
            if (perc > bestSub.val) { bestSub = { name: sub, val: perc }; }
            if (perc < worstSub.val) { worstSub = { name: sub, val: perc }; }
        });
        document.getElementById('strong-subject').textContent = bestSub.name;
        document.getElementById('weak-subject').textContent = worstSub.name;

        app.saveStats(passed, timeTaken.trim(), avgSeconds);
        app.showSection('result');
    },

    renderSubjectPerformance: (stats, containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        Object.keys(stats).forEach(sub => {
            const data = stats[sub];
            const perc = Math.round((data.correct / data.total) * 100);
            container.innerHTML += `
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-[10px] text-text-sec uppercase tracking-wider">${sub}</span>
                        <small class="text-white">${data.correct}/${data.total}</small>
                    </div>
                    <div class="w-full bg-gray-700 h-1.5 rounded-full">
                        <div class="h-1.5 rounded-full ${perc >= 70 ? 'bg-success' : 'bg-yellow-500'}" 
                             style="width: ${perc}%"></div>
                    </div>
                </div>
            `;
        });
    },

    showHistory: () => {
        app.renderHistory();
        app.showSection('history');
    },

    renderHistory: () => {
        const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
        const container = document.getElementById('history-list');
        
        if (history.length === 0) {
            container.innerHTML = '<div class="text-center text-text-sec py-12"><i class="fas fa-history fa-2x mb-3 block"></i><p>No exams taken yet.</p></div>';
            return;
        }

        let html = '';
        history.forEach((h, index) => {
            const passed = h.percentage >= CONFIG.passMark;
            const borderColor = passed ? 'border-l-success' : 'border-l-error';
            const scoreColor = passed ? 'text-success' : 'text-error';
            
            html += `
                <div class="bg-surface rounded-lg p-4 shadow border-l-4 ${borderColor} flex justify-between items-center cursor-pointer hover:bg-surface-hover transition-colors"
                     onclick="app.showHistoryDetails(${index})">
                    <div>
                        <div class="font-bold text-white">${h.date}</div>
                        <small class="text-text-sec">Score: ${h.score}/${h.total}</small>
                    </div>
                    <div class="text-2xl font-bold ${scoreColor}">
                        ${h.percentage}%
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    },

    showHistoryDetails: (index) => {
        const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
        const item = history[index];
        if(!item) return;

        const modalBody = document.getElementById('history-modal-body');
        
        if(!item.subjectDetails) {
            modalBody.innerHTML = `
                <div class="text-center py-8">
                    <h2 class="text-4xl font-bold mb-4">${item.percentage}%</h2>
                    <p class="text-text-sec mb-4">Detailed breakdown not available for this record.</p>
                    <div class="text-sm">Date: ${item.date}<br>Score: ${item.score}/${item.total}</div>
                </div>
            `;
        } else {
            let avgFeedback = item.avgTime <= CONFIG.avgTimeTarget 
                ? `<span class="text-success">Good (<2m)</span>` 
                : `<span class="text-yellow-500">Slow (>2m)</span>`;

            modalBody.innerHTML = `
                <div class="text-center mb-8">
                    <div class="w-24 h-24 rounded-full border-4 flex items-center justify-center mx-auto mb-4 text-3xl font-bold ${item.percentage >= CONFIG.passMark ? 'border-success text-success' : 'border-error text-error'}">
                        ${item.percentage}%
                    </div>
                    <h5 class="text-lg">${item.date}</h5>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-8 text-center divide-x divide-gray-700">
                    <div>
                        <small class="text-text-sec text-[10px] uppercase">Score</small>
                        <div class="font-bold text-lg">${item.score}/${item.total}</div>
                    </div>
                    <div>
                        <small class="text-text-sec text-[10px] uppercase">Time</small>
                        <div class="font-bold text-lg">${item.timeTaken}</div>
                    </div>
                    <div>
                        <small class="text-text-sec text-[10px] uppercase">Avg/Q</small>
                        <div class="font-bold text-lg">${item.avgTime}s</div>
                        <small class="text-xs">${avgFeedback}</small>
                    </div>
                </div>
                <h6 class="text-text-sec text-xs uppercase tracking-widest mb-4 border-b border-gray-700 pb-2">Subject Performance</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4" id="history-subject-stats"></div>
            `;
            
            setTimeout(() => {
                app.renderSubjectPerformance(item.subjectDetails, 'history-subject-stats');
            }, 0);
        }

        app.openModal('historyDetailsModal');
    },

    clearHistory: () => {
        if(confirm('Are you sure you want to clear all exam history?')) {
            localStorage.removeItem('quizHistory');
            localStorage.removeItem('quizStats');
            app.renderHistory();
            app.loadStats();
        }
    },

    showSubjectModal: () => {
        app.populateSubjectModal(); 
        app.openModal('subjectModal');
    },

    populateSubjectModal: () => {
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = '<div class="divide-y divide-gray-700" id="subject-list"></div>';
        const list = document.getElementById('subject-list');
        
        document.getElementById('modal-title').textContent = "Select Subject";

        if (!QUESTIONS_DB || QUESTIONS_DB.length === 0) {
            list.innerHTML = '<div class="text-center p-6 text-text-sec">No questions loaded.</div>';
            return;
        }

        const subjects = [...new Set(QUESTIONS_DB.map(q => q.subject))];
        subjects.forEach(sub => {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left py-4 px-6 hover:bg-surface-hover text-gray-200 transition-colors flex items-center group';
            btn.innerHTML = `<i class="fas fa-book mr-3 text-gray-500 group-hover:text-primary transition-colors"></i> ${sub}`;
            btn.onclick = () => app.startSubjectFlow(sub); 
            list.appendChild(btn);
        });
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>