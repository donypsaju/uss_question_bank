<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USS QUIZ FOR TEACHERS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* General body and container styling for full height */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            font-family: 'Inter', sans-serif;
        }
        .quiz-container {
            height: 100%;
            padding: 1rem;
            margin: 0;
            max-width: 100%;
        }
        /* Start screen layout */
        #start-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        /* Styling for selection panels on the start screen */
        #subject-selection, #chapter-selection {
            width: 100%;
            max-width: 800px;
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
        }
        /* Quiz and Results screen initial state */
        #quiz-screen, #results-screen {
            height: 100%;
            display: none;
            overflow-y: auto;
        }
        /* Styling for each multiple-choice option */
        .option {
            padding: 1rem;
            margin: 0.5rem 0;
            border: 2px solid #ddd;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .option:hover {
            background-color: #e9ecef;
            border-color: #0d6efd;
        }
        .option-letter {
            font-weight: bold;
            margin-right: 1rem;
            min-width: 30px;
            font-size: 1.2rem;
            color: #495057;
        }
        .correct-answer {
            background-color: #d1e7dd;
            border-color: #a3cfbb;
            font-weight: bold;
        }
        .question-text {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        /* Specific font for Malayalam text */
        .malayalam-text {
            font-family: 'Noto Sans Malayalam', sans-serif;
        }
        /* Styling for question images */
        .question-image {
            max-height: 250px;
            cursor: zoom-in;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            transition: transform 0.3s ease;
        }
        .question-image.zoomed {
            transform: scale(2.5);
            cursor: zoom-out;
            z-index: 100;
            position: relative;
            background: white;
            box-shadow: 0 0 25px rgba(0,0,0,0.3);
        }
        .timer {
            font-size: 1.3rem;
            font-weight: bold;
            margin-right: 1.5rem;
        }
        /* Header within the quiz screen */
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        /* Styling for each answer item on the results page */
        .answer-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .time-taken {
            font-weight: bold;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }
        /* Floating font-size control */
        .font-size-control {
            position: fixed;
            bottom: 100px; /* Increased bottom to not overlap nav buttons */
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .font-size-slider {
            width: 180px;
        }
        /* Subject selection buttons */
        .subject-btn {
            margin: 5px;
            padding: 10px 15px;
            width: 220px;
        }
        /* Styling for each chapter item in the selection list */
        .chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .chapter-item:nth-child(odd) {
            background-color: #f8f9fa;
        }
        .question-count-select {
            width: 100px;
            display: inline-block;
            margin-left: 1rem;
        }
        /* Fixed navigation buttons at the bottom */
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+Malayalam&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container-fluid quiz-container">
        <!-- Start Screen -->
        <div id="start-screen" class="text-center">
            <h1 class="mb-4">USS QUIZ BANK FOR TEACHERS</h1>
            
            <div id="subject-selection" class="mb-4">
                <h4 class="mb-3">Select Test Type:</h4>
                <button id="all-subjects-btn" class="btn btn-primary subject-btn">All Subjects</button>
                <button data-subject="Part I Malayalam" class="btn btn-secondary subject-btn">Part I Malayalam</button>
                <button data-subject="Part II Malayalam" class="btn btn-secondary subject-btn">Part II Malayalam</button>
                <button data-subject="Maths" class="btn btn-secondary subject-btn">Maths</button>
                <button data-subject="English" class="btn btn-secondary subject-btn">English</button>
                <button data-subject="Basic Science" class="btn btn-secondary subject-btn">Basic Science</button>
                <button data-subject="Social Science" class="btn btn-secondary subject-btn">Social Science</button>
            </div>
            
            <div id="chapter-selection" class="mb-4" style="display: none;">
                <!-- Chapters will be populated by JavaScript -->
            </div>
            
            <button id="start-quiz-btn" class="btn btn-success btn-lg" style="display: none;">Start Quiz</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen">
            <div class="quiz-header">
                <div>
                    <span id="question-counter" class="fw-bold"></span>
                    <span id="subject-display" class="badge bg-secondary ms-2"></span>
                    <span id="chapter-display" class="badge bg-info ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <span id="timer" class="timer">00:00</span>
                    <button id="language-toggle" class="btn btn-sm btn-outline-secondary">മലയാളം</button>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-body p-4">
                    <!-- FIXED: Removed the 'fs-4' class to allow JS to control font size -->
                    <div id="question-text" class="question-text"></div>
                    <div id="question-image-container" class="text-center"></div>
                </div>
            </div>
            
            <div id="options-container" class="mb-5 pb-5">
                <!-- Options will be inserted here -->
            </div>
            
            <!-- Font Size Control -->
            <div class="font-size-control">
                <div class="d-flex align-items-center mb-1">
                    <small class="me-2">A</small>
                    <input type="range" id="font-size-slider" class="form-range font-size-slider" min="1" max="5" step="0.5" value="3">
                    <small class="ms-2" style="font-size: 1.5rem;">A</small>
                </div>
                <small class="text-muted d-block text-center">Adjust Font Size</small>
            </div>
            
            <div class="nav-buttons d-flex justify-content-between p-3">
                <button id="prev-btn" class="btn btn-secondary">Previous</button>
                <button id="reveal-btn" class="btn btn-warning">Reveal Answer</button>
                <button id="next-btn" class="btn btn-primary">Next</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Quiz Results</h2>
                <button id="results-language-toggle" class="btn btn-sm btn-outline-secondary">മലയാളം</button>
            </div>
            
            <div id="time-taken" class="time-taken"></div>
            <div id="answers-container" class="pb-5"></div>
            
            <div class="nav-buttons text-center p-3">
                <button id="restart-btn" class="btn btn-primary">Restart Quiz</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const subjectSelection = document.getElementById('subject-selection');
        const chapterSelection = document.getElementById('chapter-selection');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const subjectButtons = document.querySelectorAll('.subject-btn');

        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const revealBtn = document.getElementById('reveal-btn');
        const restartBtn = document.getElementById('restart-btn');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const questionCounter = document.getElementById('question-counter');
        const subjectDisplay = document.getElementById('subject-display');
        const chapterDisplay = document.getElementById('chapter-display');
        const languageToggle = document.getElementById('language-toggle');
        const resultsLanguageToggle = document.getElementById('results-language-toggle');
        const questionImageContainer = document.getElementById('question-image-container');
        const answersContainer = document.getElementById('answers-container');
        const timerDisplay = document.getElementById('timer');
        const timeTakenDisplay = document.getElementById('time-taken');
        const fontSizeSlider = document.getElementById('font-size-slider');

        // Quiz state variables
        let questions = [];
        let currentQuestionIndex = 0;
        let selectedQuestions = [];
        let answerRevealed = false;
        let selectedSubject = null; // Can be null (all) or a string (e.g., "Maths")
        let currentLanguage = 'english';
        let startTime;
        let timerInterval;
        const optionLetters = ['A', 'B', 'C', 'D'];
        
        // Font size variables
        let questionFontSize = 1.8;
        let optionFontSize = 1.5;

        // Initialize the app
        loadQuestions();

        // --- Utility Functions ---

        // Shuffle array using Fisher-Yates algorithm
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Get random elements from an array
        function getRandomElements(array, count) {
            if (array.length === 0) return [];
            const shuffled = shuffleArray(array);
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        // --- Initialization and Setup ---

        // Load questions from the JSON file
        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) throw new Error('Network response was not ok');
                questions = await response.json();
                loadSettings(); // Load saved settings after questions are loaded
            } catch (error) {
                console.error('Error loading questions:', error);
                startScreen.innerHTML = `<div class="alert alert-danger">Failed to load questions.json. Please ensure the file exists and is correctly formatted.</div>`;
            }
        }

        // Load saved settings from localStorage
        function loadSettings() {
            const savedLanguage = localStorage.getItem('quizLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                updateLanguageButtonText();
            }
            const savedQuestionSize = localStorage.getItem('questionFontSize');
            if (savedQuestionSize) questionFontSize = parseFloat(savedQuestionSize);
            const savedOptionSize = localStorage.getItem('optionFontSize');
            if (savedOptionSize) optionFontSize = parseFloat(savedOptionSize);
            
            fontSizeSlider.value = (parseFloat(savedQuestionSize) - 1.0) / 0.8 || 3;
            applyFontSizes();
        }

        // Update the text on the language toggle buttons
        function updateLanguageButtonText() {
            const text = currentLanguage === 'english' ? 'മലയാളം' : 'English';
            languageToggle.textContent = text;
            resultsLanguageToggle.textContent = text;
        }

        // --- Start Screen Logic ---

        // Add event listeners to all subject buttons
        subjectButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                selectedSubject = this.dataset.subject || null; // null for "All Subjects"
                subjectButtons.forEach(b => {
                    b.classList.remove('btn-primary', 'active');
                    b.classList.add('btn-secondary');
                });
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary', 'active');
                showChapterSelection();
            });
        });

        // Display the chapter selection UI based on the chosen subject
        function showChapterSelection() {
            const isAllSubjects = selectedSubject === null;
            let filteredChapters;

            if (isAllSubjects) {
                filteredChapters = [...new Set(questions.map(q => q.chapter))];
            } else {
                filteredChapters = [...new Set(questions.filter(q => q.subject === selectedSubject).map(q => q.chapter))];
            }
            filteredChapters.sort((a, b) => a - b);

            let chapterHtml = `<h4 class="mb-3">Select Chapters for ${selectedSubject || 'All Subjects'}:</h4>`;
            if (filteredChapters.length === 0) {
                chapterHtml += '<p>No chapters found for the selected subject.</p>';
            } else {
                filteredChapters.forEach(chapter => {
                    chapterHtml += `
                        <div class="chapter-item form-check">
                            <div>
                                <input class="form-check-input chapter-checkbox" type="checkbox" value="${chapter}" id="chapter-${chapter}" checked>
                                <label class="form-check-label" for="chapter-${chapter}">Chapter ${chapter}</label>
                            </div>
                            ${!isAllSubjects ? `
                            <div>
                                <label for="count-${chapter}" class="form-label me-2 small">Questions:</label>
                                <select class="form-select form-select-sm question-count-select" id="count-${chapter}" data-chapter="${chapter}">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="all">All</option>
                                </select>
                            </div>
                            ` : ''}
                        </div>`;
                });
            }
            
            chapterSelection.innerHTML = chapterHtml;
            chapterSelection.style.display = 'block';
            startQuizBtn.style.display = 'inline-block';
        }

        // --- Quiz Generation and Control ---

        // Main function to select questions based on user criteria
        function selectQuestions() {
            if (selectedSubject) {
                // --- Single Subject Logic (questions are shuffled) ---
                let finalQuestions = [];
                const chapterItems = document.querySelectorAll('#chapter-selection .chapter-item');
                chapterItems.forEach(item => {
                    const checkbox = item.querySelector('.chapter-checkbox');
                    if (checkbox.checked) {
                        const chapterNumber = parseInt(checkbox.value);
                        const countSelector = item.querySelector('.question-count-select');
                        const requestedCountStr = countSelector.value;
                        
                        const questionsFromChapter = questions.filter(q => 
                            q.subject === selectedSubject && q.chapter === chapterNumber
                        );

                        let countToTake = 0;
                        if (requestedCountStr === 'all') {
                            countToTake = questionsFromChapter.length;
                        } else {
                            countToTake = Math.min(parseInt(requestedCountStr), questionsFromChapter.length);
                        }

                        finalQuestions.push(...getRandomElements(questionsFromChapter, countToTake));
                    }
                });
                return shuffleArray(finalQuestions);

            } else {
                // --- All Subjects Logic (subjects are in order) ---
                const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked')).map(cb => parseInt(cb.value));
                if (selectedChapters.length === 0) return [];

                let filteredQuestions = questions.filter(q => selectedChapters.includes(q.chapter));
                
                const part1Malayalam = getRandomElements(filteredQuestions.filter(q => q.subject === "Part I Malayalam"), 5);
                const part2Malayalam = getRandomElements(filteredQuestions.filter(q => q.subject === "Part II Malayalam"), 5);
                const maths = getRandomElements(filteredQuestions.filter(q => q.subject === "Maths"), 10);
                const english = getRandomElements(filteredQuestions.filter(q => q.subject === "English"), 5);
                const basicScience = getRandomElements(filteredQuestions.filter(q => q.subject === "Basic Science"), 10);
                const socialScience = getRandomElements(filteredQuestions.filter(q => q.subject === "Social Science"), 10);
                
                // FIXED: Return the concatenated array without shuffling to maintain subject order
                return [
                    ...part1Malayalam, ...part2Malayalam, ...maths, ...english, ...basicScience, ...socialScience
                ].filter(q => q); // filter out any potential undefined items
            }
        }

        // Start the quiz
        function startQuiz() {
            selectedQuestions = selectQuestions();
            
            if (selectedQuestions.length === 0) {
                alert('No questions found for the selected criteria. Please check your selections.');
                return;
            }
            
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
            
            currentQuestionIndex = 0;
            answerRevealed = false;
            
            startScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            quizScreen.style.display = 'block';
            
            loadQuestion();
        }

        // --- In-Quiz Functions ---

        // Load and display the current question and options
        function loadQuestion() {
            answerRevealed = false;
            const question = selectedQuestions[currentQuestionIndex];
            
            questionCounter.textContent = `Q ${currentQuestionIndex + 1}/${selectedQuestions.length}`;
            subjectDisplay.textContent = question.subject;
            chapterDisplay.textContent = `Chapter ${question.chapter}`;
            
            updateQuestionAndOptionText();
            displayQuestionImage(question.image);

            // Update nav buttons and scroll to top
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        // Update the language of the currently displayed question and options
        function updateQuestionAndOptionText() {
            const question = selectedQuestions[currentQuestionIndex];
            if (!question) return;

            // Update question text
            if (currentLanguage === 'malayalam' && question.malayalam_question) {
                questionText.textContent = question.malayalam_question;
                questionText.classList.add('malayalam-text');
            } else {
                questionText.textContent = question.question;
                questionText.classList.remove('malayalam-text');
            }

            // Create options and shuffle them
            const options = [
                { text: question.option1, malayalam: question.malayalam_option1, isCorrect: question.answer === question.option1 },
                { text: question.option2, malayalam: question.malayalam_option2, isCorrect: question.answer === question.option2 },
                { text: question.option3, malayalam: question.malayalam_option3, isCorrect: question.answer === question.option3 },
                { text: question.option4, malayalam: question.malayalam_option4, isCorrect: question.answer === question.option4 }
            ];
            const shuffledOptions = shuffleArray(options);

            optionsContainer.innerHTML = '';
            shuffledOptions.forEach((opt, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.dataset.correct = opt.isCorrect;

                const optionLetter = document.createElement('div');
                optionLetter.className = 'option-letter';
                optionLetter.textContent = optionLetters[index];
                
                const optionContent = document.createElement('div');
                optionContent.className = 'option-content';
                
                if (currentLanguage === 'malayalam' && opt.malayalam) {
                    optionContent.textContent = opt.malayalam;
                    optionContent.classList.add('malayalam-text');
                } else {
                    optionContent.textContent = opt.text;
                    optionContent.classList.remove('malayalam-text');
                }
                
                optionDiv.appendChild(optionLetter);
                optionDiv.appendChild(optionContent);
                optionsContainer.appendChild(optionDiv);
            });
            // Apply font sizes after creating the elements
            applyFontSizes(); 
        }

        // Reveal the correct answer
        function revealAnswer() {
            answerRevealed = true;
            document.querySelectorAll('.option').forEach(option => {
                if (option.dataset.correct === 'true') {
                    option.classList.add('correct-answer');
                }
            });
            revealBtn.textContent = 'Answer Revealed';
            revealBtn.disabled = true;
        }

        // --- Navigation and UI Updates ---

        function updateNavButtons() {
            prevBtn.classList.toggle('d-none', currentQuestionIndex === 0);
            nextBtn.textContent = currentQuestionIndex === selectedQuestions.length - 1 ? 'Finish' : 'Next';
            revealBtn.textContent = 'Reveal Answer';
            revealBtn.disabled = false;
        }

        function nextQuestion() {
            if (currentQuestionIndex < selectedQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                showResults();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        // --- Font Size Control ---
        function updateFontSizes() {
            const sliderValue = parseFloat(fontSizeSlider.value);
            // Define a mapping from slider value (1-5) to font sizes
            questionFontSize = 1.0 + (sliderValue * 0.8);
            optionFontSize = 0.9 + (sliderValue * 0.7);
            
            localStorage.setItem('questionFontSize', questionFontSize.toString());
            localStorage.setItem('optionFontSize', optionFontSize.toString());
            
            applyFontSizes();
        }

        function applyFontSizes() {
            // Apply to quiz screen question text
            if (questionText) {
                questionText.style.fontSize = `${questionFontSize}rem`;
                questionText.style.lineHeight = '1.5';
            }
            
            // Apply to quiz screen options
            document.querySelectorAll('.option-letter, .option-content').forEach(option => {
                option.style.fontSize = `${optionFontSize}rem`;
                option.style.lineHeight = '1.5';
            });
            
            // Apply to results screen if visible
            if (resultsScreen.style.display === 'block') {
                answersContainer.querySelectorAll('.answer-item .fw-bold').forEach(q => {
                    q.style.fontSize = `${questionFontSize}rem`;
                });
                answersContainer.querySelectorAll('.answer-item div:not(.fw-bold)').forEach(opt => {
                    opt.style.fontSize = `${optionFontSize}rem`;
                });
            }
        }
        
        // --- Language Toggle ---
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'english' ? 'malayalam' : 'english';
            localStorage.setItem('quizLanguage', currentLanguage);
            updateLanguageButtonText();
            updateQuestionAndOptionText(); // Reload text without reloading entire question logic
        }
        
        function toggleResultsLanguage() {
            currentLanguage = currentLanguage === 'english' ? 'malayalam' : 'english';
            localStorage.setItem('quizLanguage', currentLanguage);
            updateLanguageButtonText();
            showResults(); // Regenerate results with new language
        }

        // --- Timer Functions ---
        function updateTimer() {
            const elapsed = new Date(new Date() - startTime);
            const minutes = elapsed.getUTCMinutes().toString().padStart(2, '0');
            const seconds = elapsed.getUTCSeconds().toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }

        function formatTimeTaken(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} minute${minutes !== 1 ? 's' : ''} and ${seconds} second${seconds !== 1 ? 's' : ''}`;
        }

        // --- Image Display ---
        function displayQuestionImage(imagePath) {
            questionImageContainer.innerHTML = '';
            if (imagePath && imagePath !== 'null') {
                const img = document.createElement('img');
                img.src = imagePath;
                img.alt = "Question image";
                img.className = "question-image img-fluid rounded";
                img.addEventListener('click', () => img.classList.toggle('zoomed'));
                questionImageContainer.appendChild(img);
                questionImageContainer.style.display = 'block';
            } else {
                questionImageContainer.style.display = 'none';
            }
        }

        // --- Results Screen ---
        function showResults() {
            clearInterval(timerInterval);
            const timeTaken = new Date() - startTime;
            
            timeTakenDisplay.textContent = `Time taken: ${formatTimeTaken(timeTaken)}`;
            
            quizScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            
            answersContainer.innerHTML = '';
            selectedQuestions.forEach((q, index) => {
                let optionsHtml = '';
                for (let i = 1; i <= 4; i++) {
                    const optionText = (currentLanguage === 'malayalam' && q[`malayalam_option${i}`]) ? q[`malayalam_option${i}`] : q[`option${i}`];
                    const isCorrect = q[`option${i}`] === q.answer;
                    optionsHtml += `<div class="ms-3 ${isCorrect ? 'text-success fw-bold' : ''}">${optionLetters[i-1]}. ${optionText}</div>`;
                }

                const questionTextContent = (currentLanguage === 'malayalam' && q.malayalam_question) ? q.malayalam_question : q.question;
                const answerItem = document.createElement('div');
                answerItem.className = 'answer-item';
                answerItem.innerHTML = `
                    <div class="fw-bold mb-2">${index + 1}. ${questionTextContent}</div>
                    ${optionsHtml}
                `;
                answersContainer.appendChild(answerItem);
            });
            
            applyFontSizes(); // Apply font sizes to the newly created results
            window.scrollTo(0, 0);
        }

        // --- Restart ---
        function restartQuiz() {
            startScreen.style.display = 'flex';
            quizScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            chapterSelection.style.display = 'none';
            startQuizBtn.style.display = 'none';
            
            subjectButtons.forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-secondary');
            });
            
            selectedSubject = null;
        }

        // --- Event Listeners ---
        startQuizBtn.addEventListener('click', startQuiz);
        restartBtn.addEventListener('click', restartQuiz);
        nextBtn.addEventListener('click', nextQuestion);
        prevBtn.addEventListener('click', prevQuestion);
        revealBtn.addEventListener('click', revealAnswer);
        languageToggle.addEventListener('click', toggleLanguage);
        resultsLanguageToggle.addEventListener('click', toggleResultsLanguage);
        fontSizeSlider.addEventListener('input', updateFontSizes);
    });
    </script>
</body>
</html>
